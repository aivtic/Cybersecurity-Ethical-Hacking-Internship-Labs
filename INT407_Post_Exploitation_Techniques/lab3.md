
# Lab 3: Horizontal Privilege Escalation via URL Manipulation (Real Test)

### **Objective:**
In this lab, you will explore and test horizontal privilege escalation in a web application. The attacker manipulates the `employee_id` parameter in the URL to access the profile of another user without proper authorization.

### **Lab Setup:**

1. **Victim Machine**: A vulnerable machine (e.g., Metasploitable or a custom vulnerable application).
2. **Attacker Machine**: Kali Linux (or any attacker machine used to perform the exploitation).
3. **Web Application**: A simple vulnerable web application running on the victim machine, where users can view their profiles by navigating to `https://<victim_ip>/profile?employee_id=<id>`.
   - Replace `<victim_ip>` with the actual IP address of the vulnerable web server.
   - Replace `<id>` with a numeric `employee_id` corresponding to each user.

---

### **1. Set Up the Web Application (Victim Machine)**

First, you need to create a vulnerable application on the victim machine. You will use a Python Flask web application.

**Step-by-Step Instructions for the Victim Machine:**

1. **Install Flask**:
   - On the victim machine, run the following commands to install Flask if it’s not already installed:
   
   ```bash
   sudo apt update
   sudo apt install python3-pip
   pip3 install flask
   ```

2. **Create the Web Application (`app.py`)**:
   - On the victim machine, create a Python file named `app.py` and paste the following code to create a simple vulnerable web application:

   ```python
   from flask import Flask, request, jsonify

   app = Flask(__name__)

   # Simulated user data (example users)
   users = {
       "12345": {"name": "John Doe", "email": "john.doe@company.com", "role": "Employee"},
       "67890": {"name": "Alice Smith", "email": "alice.smith@company.com", "role": "Manager"},
       "54321": {"name": "Bob Johnson", "email": "bob.johnson@company.com", "role": "HR"},
   }

   @app.route('/profile', methods=['GET'])
   def profile():
       employee_id = request.args.get('employee_id')
       
       if employee_id in users:
           user = users[employee_id]
           return jsonify(user), 200
       else:
           return jsonify({"error": "User not found!"}), 404

   if __name__ == "__main__":
       app.run(host='0.0.0.0', port=80)
   ```

3. **Run the Application**:
   - Start the application by running:
   
   ```bash
   sudo python3 app.py
   ```

   The web application will be accessible at `http://<victim_ip>/profile?employee_id=<id>`.

---

### **2. Exploit Horizontal Privilege Escalation (Attacker Machine)**

**Objective**: The attacker (you) will test horizontal privilege escalation by manipulating the `employee_id` parameter to access other users' profiles.

**Step-by-Step Instructions for the Attacker Machine:**

1. **Identify a valid user ID:**
   - Assume you're logged into the application with a legitimate user account (e.g., `employee_id=12345` for John Doe).
   - The profile URL for John Doe will be:
   
   ```
   http://<victim_ip>/profile?employee_id=12345
   ```

2. **Manipulate the URL to access another user’s profile:**
   - Change the `employee_id` parameter in the URL to another user’s ID (e.g., `67890` for Alice Smith or `54321` for Bob Johnson).

   Example URLs:
   
   ```
   http://<victim_ip>/profile?employee_id=67890
   http://<victim_ip>/profile?employee_id=54321
   ```

3. **Observe the results:**
   - If there are no access controls, you should be able to view the profiles of users you should not have access to.

**Expected Outcome:**
   - You will successfully access unauthorized user profiles, demonstrating horizontal privilege escalation.

---

### **3. Verifying the Impact**

**Objective**: Understand the consequences of the horizontal privilege escalation vulnerability.

**Step-by-Step Instructions for Verification:**

1. **Explore data exposure**:
   - By manipulating the `employee_id` parameter, you gain unauthorized access to sensitive data of other users.
   
2. **Possible Data Exposure**:
   - **Name**, **Email address**, **Role** within the company.

**Impact**:
   - In a real-world scenario, attackers could expose private information about employees, internal reports, and confidential company data.

---

### **4. Preventing Horizontal Privilege Escalation**

Now that you understand how the vulnerability works, it’s important to implement security measures to mitigate it.

**Step-by-Step Instructions for Fixing the Vulnerability:**

1. **Modify the Flask app**:
   Implement session-based access control to prevent users from accessing profiles that don't belong to them.

**Updated `app.py` code** with session-based checks:

```python
from flask import Flask, request, jsonify, session

app = Flask(__name__)
app.secret_key = 'supersecretkey'

# Simulated user data (example users)
users = {
    "12345": {"name": "John Doe", "email": "john.doe@company.com", "role": "Employee"},
    "67890": {"name": "Alice Smith", "email": "alice.smith@company.com", "role": "Manager"},
    "54321": {"name": "Bob Johnson", "email": "bob.johnson@company.com", "role": "HR"},
}

@app.route('/login', methods=['POST'])
def login():
    employee_id = request.form.get('employee_id')
    if employee_id in users:
        session['employee_id'] = employee_id
        return jsonify({"message": "Logged in successfully!"}), 200
    return jsonify({"error": "Invalid credentials"}), 401

@app.route('/profile', methods=['GET'])
def profile():
    if 'employee_id' not in session:
        return jsonify({"error": "Unauthorized access!"}), 403
    
    logged_in_id = session['employee_id']
    employee_id = request.args.get('employee_id')
    
    if logged_in_id != employee_id:
        return jsonify({"error": "Unauthorized access!"}), 403

    if employee_id in users:
        user = users[employee_id]
        return jsonify(user), 200
    else:
        return jsonify({"error": "User not found!"}), 404

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=80)
```

2. **Fix Summary**:
   - **Login Endpoint**: Users must log in with their `employee_id` to establish a session.
   - **Profile Endpoint**: The system checks if the logged-in user matches the `employee_id` in the URL. Unauthorized users are denied access.

---

### **5. Final Tasks**

**Objective**: Test the fix and ensure that horizontal privilege escalation is properly mitigated.

1. **Test the fix**:
   - After applying the fix, try accessing other users’ profiles. You should receive a "403 Unauthorized" error.
   
2. **Write a Report**:
   - Document the steps you took in the lab, including:
     - **The vulnerability** (horizontal privilege escalation via URL manipulation).
     - **The risk** to sensitive data.
     - **The fix** (session-based authorization checks).

---

### **Conclusion:**

In this lab, you learned how to identify and exploit a **horizontal privilege escalation** vulnerability via URL manipulation in a vulnerable web application. You also learned how to fix the vulnerability by implementing proper session-based authorization checks. This exercise will help you understand how easy it is to exploit poorly secured web applications and the importance of securing sensitive data with proper access controls.

---

### **Additional Exercises (Optional):**

1. **Bypass Authentication**:
   - Learn how to bypass login mechanisms by inspecting cookies or using session fixation attacks.

2. **Automate Attacks**:
   - Write a Python script to automatically try different `employee_id` values, simulating an attacker's actions in real-time.

3. **Advanced Security Measures**:
   - Implement two-factor authentication (2FA) to prevent unauthorized logins.
